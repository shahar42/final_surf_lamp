<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surf Lamp - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Primary favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v=2" sizes="32x32">

    <!-- Apple Touch Icon (iOS home screen) -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.png') }}">

    <!-- Web App Manifest (Android/PWA) -->
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

    <!-- Theme colors matching your blue gradient -->
    <meta name="theme-color" content="#00c6ff">
    <meta name="msapplication-TileColor" content="#00c6ff">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Global ocean color system -->
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <!-- Dashboard specific styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- noUiSlider for range sliders -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/range-slider.css') }}">
</head>
<body class="min-h-screen p-4">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% set parts = category.split('_') %}
          {% set base_category = parts[0] %}
          {% set timing = parts[1] if parts|length > 1 else 'default' %}
          <div class="flash-message px-6 py-3 rounded-lg text-white font-semibold {{ 'bg-green-500' if base_category == 'success' else 'bg-red-500' }} shadow-lg" data-timing="{{ timing }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- LED Strip Visualization -->
    <div class="max-w-6xl mx-auto mb-6 lg:mb-2">
        <!-- Removed 'card', 'shadow-2xl', 'bg-...' classes to make it float -->
        <div class="w-full flex justify-center">
            <div class="flex flex-col items-center w-full">
                <!-- Surfboard LED Visualization -->
                <div class="flex flex-col items-center w-full overflow-hidden">
                    <!-- Surfboard Canvas with Wind Direction Compass -->
                    <div id="lampScaleContainer" class="relative inline-block origin-top" style="transform: scale(1.15);">
                        <canvas id="surfboardCanvas" width="350" height="550" role="img" aria-label="Surfboard LED visualization showing current surf conditions with three LED strips for wave period, wind speed, and wave height">
                            Your browser does not support the canvas element. Current surf conditions: Wave height {{ data.conditions.wave_height_m }}m, Wind speed {{ data.conditions.wind_speed_mps }} m/s, Wave period {{ data.conditions.wave_period_s }}s.
                        </canvas>
                        <!-- Wind Direction Compass Overlay -->
                        <div id="arrowContainer" class="absolute left-1/2 -translate-x-1/2 flex items-center justify-center pointer-events-none" style="width: 50px; height: 50px; top: 82px;">
                            <div class="transition-transform duration-500 origin-center" id="windArrow" style="transform: rotate({{ (data.conditions.wind_direction_deg + 180) if data.conditions.wind_direction_deg else 0 }}deg); width: 105px; height: 105px;">
                                <!-- Carved Arrow SVG (points where wind is GOING) -->
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full" style="filter: brightness(1.45);">
                                    <defs>
                                        <filter id="carvedArrow" x="-50%" y="-50%" width="200%" height="200%">
                                            <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur"/>
                                            <feOffset in="blur" dx="0" dy="0" result="offsetBlur"/>
                                            <feFlood flood-color="#000000" flood-opacity="0.3" result="floodColor"/>
                                            <feComposite in="floodColor" in2="offsetBlur" operator="in" result="innerShadow"/>
                                            <feMerge>
                                                <feMergeNode in="innerShadow"/>
                                                <feMergeNode in="SourceGraphic"/>
                                            </feMerge>
                                        </filter>
                                    </defs>
                                    <path d="M12 3 Q11.5 21 12 21 M12 3 Q9 3 6 10 M12 3 Q15 3 18 10" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.2" filter="url(#carvedArrow)"/>
                                </svg>
                            </div>
                        </div>
                        <!-- Strip Labels (P, W, H) -->
                        <div id="stripLabelP" class="absolute font-bold pointer-events-none" style="left: 140px; top: 448px; font-size: 12px; color: #000000; opacity: 0.3;">P</div>
                        <div id="stripLabelW" class="absolute font-bold pointer-events-none" style="left: 169px; top: 448px; font-size: 12px; color: #000000; opacity: 0.3;">W</div>
                        <div id="stripLabelH" class="absolute font-bold pointer-events-none" style="left: 201px; top: 448px; font-size: 12px; color: #000000; opacity: 0.3;">H</div>
                    </div>

                    <!-- Legend & Data Values -->
                    <div id="legendContainer" class="relative w-[350px] mx-auto text-white/90 text-sm font-semibold pointer-events-none transition-all duration-300">
                        <div class="flex justify-between items-start transition-all duration-300" id="legendRow">
                            <!-- Left: Period -->
                            <div class="flex flex-col items-center gap-1 w-24 text-center">
                                <span class="text-white/70 text-xs uppercase tracking-wider">Period</span>
                            </div>
                            
                            <!-- Center: Wind -->
                            <div class="flex flex-col items-center gap-1 w-24 text-center">
                                <span class="text-white/70 text-xs uppercase tracking-wider">Wind</span>
                            </div>

                            <!-- Right: Height -->
                            <div class="flex flex-col items-center gap-1 w-24 text-center">
                                <span class="text-white/70 text-xs uppercase tracking-wider">Height</span>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Apply Visual Calibration from Config
                        document.addEventListener('DOMContentLoaded', () => {
                            const cal = DashboardConfig.CALIBRATION.LAYOUT;
                            
                            // Lamp Scale
                            const lampContainer = document.getElementById('lampScaleContainer');
                            if (lampContainer) {
                                lampContainer.style.transform = `scale(${cal.LAMP_SCALE})`;
                            }

                            // Arrow Position & Size
                            const arrowContainer = document.getElementById('arrowContainer');
                            const windArrow = document.getElementById('windArrow');
                            if (arrowContainer) arrowContainer.style.top = `${cal.ARROW_TOP_Y}px`;
                            if (windArrow) {
                                windArrow.style.width = `${cal.ARROW_SIZE}px`;
                                windArrow.style.height = `${cal.ARROW_SIZE}px`;
                            }

                            // Legend Position & Spread
                            const legendContainer = document.getElementById('legendContainer');
                            const legendRow = document.getElementById('legendRow');
                            if (legendContainer) legendContainer.style.marginTop = `${cal.LEGEND_MARGIN_TOP}px`;
                            if (legendRow) {
                                legendRow.style.paddingLeft = `${cal.LEGEND_SPREAD}px`;
                                legendRow.style.paddingRight = `${cal.LEGEND_SPREAD}px`;
                            }

                            // Strip Labels (P, W, H)
                            const labels = DashboardConfig.CALIBRATION.STRIP_LABELS;
                            const labelP = document.getElementById('stripLabelP');
                            const labelW = document.getElementById('stripLabelW');
                            const labelH = document.getElementById('stripLabelH');

                            if (labelP) {
                                labelP.style.fontSize = `${labels.FONT_SIZE}px`;
                                labelP.style.top = `${labels.TOP_Y}px`;
                                labelP.style.left = `${labels.LEFT_LABEL_X}px`;
                            }
                            if (labelW) {
                                labelW.style.fontSize = `${labels.FONT_SIZE}px`;
                                labelW.style.top = `${labels.TOP_Y}px`;
                                labelW.style.left = `${labels.CENTER_LABEL_X}px`;
                            }
                            if (labelH) {
                                labelH.style.fontSize = `${labels.FONT_SIZE}px`;
                                labelH.style.top = `${labels.TOP_Y}px`;
                                labelH.style.left = `${labels.RIGHT_LABEL_X}px`;
                            }
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- LED Underlayer Control Panel (Development Tool) -->
    <div id="underlayerControlPanel" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="bg-gray-900/95 backdrop-blur-lg rounded-xl shadow-2xl p-6 w-80 max-h-[80vh] overflow-y-auto border border-blue-500/30">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-white/20">
                <h3 class="text-white font-bold text-lg">Underlayer Config</h3>
                <button onclick="toggleUnderlayerPanel()" class="text-white/70 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Left Strip -->
            <div class="mb-6 pb-4 border-b border-white/10">
                <h4 class="text-yellow-400 font-semibold mb-3 text-sm">Left (Period)</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-white/70 text-xs">X: <span id="leftXVal">0</span>px</label>
                        <input type="range" id="leftX" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Y: <span id="leftYVal">0</span>px</label>
                        <input type="range" id="leftY" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Opacity: <span id="leftOpacityVal">0.3</span></label>
                        <input type="range" id="leftOpacity" min="0" max="1" value="0.3" step="0.05" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Color</label>
                        <input type="color" id="leftColor" value="#4a5568" class="w-full h-8 rounded cursor-pointer">
                    </div>
                </div>
            </div>

            <!-- Center Strip -->
            <div class="mb-6 pb-4 border-b border-white/10">
                <h4 class="text-blue-400 font-semibold mb-3 text-sm">Center (Wind)</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-white/70 text-xs">X: <span id="centerXVal">0</span>px</label>
                        <input type="range" id="centerX" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Y: <span id="centerYVal">0</span>px</label>
                        <input type="range" id="centerY" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Opacity: <span id="centerOpacityVal">0.3</span></label>
                        <input type="range" id="centerOpacity" min="0" max="1" value="0.3" step="0.05" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Color</label>
                        <input type="color" id="centerColor" value="#4a5568" class="w-full h-8 rounded cursor-pointer">
                    </div>
                </div>
            </div>

            <!-- Right Strip -->
            <div class="mb-4">
                <h4 class="text-orange-400 font-semibold mb-3 text-sm">Right (Wave)</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-white/70 text-xs">X: <span id="rightXVal">0</span>px</label>
                        <input type="range" id="rightX" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Y: <span id="rightYVal">0</span>px</label>
                        <input type="range" id="rightY" min="-50" max="50" value="0" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Opacity: <span id="rightOpacityVal">0.3</span></label>
                        <input type="range" id="rightOpacity" min="0" max="1" value="0.3" step="0.05" class="w-full">
                    </div>
                    <div>
                        <label class="text-white/70 text-xs">Color</label>
                        <input type="color" id="rightColor" value="#4a5568" class="w-full h-8 rounded cursor-pointer">
                    </div>
                </div>
            </div>

            <button onclick="exportUnderlayerConfig()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold text-sm transition-colors mt-4">
                Export Config
            </button>
            <div id="configOutput" class="hidden mt-3 bg-black/50 p-3 rounded text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Toggle Button for Control Panel -->
    <button id="underlayerToggleBtn" onclick="toggleUnderlayerPanel()" class="fixed bottom-4 right-4 z-40 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
        </svg>
    </button>

    </div>

    <!-- Main Dashboard Content -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Lamp Information Card -->
        <div class="card rounded-2xl shadow-2xl order-2 lg:order-1 overflow-hidden">
            
            <!-- Mobile View: Drawer/Accordion -->
            <div class="block lg:hidden">
                <button onclick="document.getElementById('surf-lamp-content').classList.toggle('hidden'); document.getElementById('surf-lamp-chevron').classList.toggle('rotate-180');" 
                        class="w-full text-left p-6 flex justify-between items-center bg-white/5 hover:bg-white/10 transition-colors">
                    <h2 class="text-xl font-bold text-white">Surf data Configuration</h2>
                    <svg id="surf-lamp-chevron" class="w-6 h-6 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="surf-lamp-content" class="hidden border-t border-white/10 p-6">
                    <div class="space-y-3 text-white">
                        <div class="flex justify-between items-center">
                            <span class="text-white/80">Location:</span>
                            <select id="locationSelectMobile" aria-label="Select your location" class="bg-white/20 text-white rounded px-2 py-1 border border-white/30 text-sm font-semibold">
                                {% for location in locations %}
                                    <option value="{{ location }}" {% if location == data.user.location %}selected{% endif %}>
                                        {{ location.replace(', Israel', '') }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="location-status-mobile" class="text-sm text-white/80 mt-2"></div>

                        <!-- Perfect Waves Range Slider Mobile -->
                        <div class="space-y-2 pt-2 border-t border-white/20">
                            <span class="text-white/80">Perfect Waves</span>
                            <div class="px-2 py-2">
                                <div id="waveSliderMobile" class="my-4"></div>
                            </div>
                            <div id="threshold-status-mobile" class="text-sm text-white/80"></div>
                            <input type="hidden" id="waveThresholdMinMobile"
                                   value="{% if data.user.preferred_output == 'feet' %}{{ '%.1f'|format((data.user.wave_threshold_m if data.user.wave_threshold_m is not none else 0.0) * 3.28084) }}{% else %}{{ data.user.wave_threshold_m if data.user.wave_threshold_m is not none else 0.0 }}{% endif %}"
                                   data-unit="{{ data.user.preferred_output or 'meters' }}">
                            <input type="hidden" id="waveThresholdMaxMobile"
                                   value="{% if data.user.wave_threshold_max_m %}{% if data.user.preferred_output == 'feet' %}{{ '%.1f'|format(data.user.wave_threshold_max_m * 3.28084) }}{% else %}{{ data.user.wave_threshold_max_m }}{% endif %}{% endif %}">
                        </div>

                        <!-- Perfect Wind Range Slider Mobile -->
                        <div class="space-y-2 pt-2 border-t border-white/20">
                            <span class="text-white/80">Perfect Wind</span>
                            <div class="px-2 py-2">
                                <div id="windSliderMobile" class="my-4"></div>
                            </div>
                            <div id="wind-threshold-status-mobile" class="text-sm text-white/80"></div>
                            <input type="hidden" id="windThresholdMinMobile" value="{{ data.user.wind_threshold_knots or 22 }}">
                            <input type="hidden" id="windThresholdMaxMobile" value="{% if data.user.wind_threshold_max_knots %}{{ data.user.wind_threshold_max_knots }}{% endif %}">
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-white/20">
                            <span class="text-white/80">Units:</span>
                            <div class="flex items-center space-x-2 justify-end">
                                <button id="unitToggleMobile" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm text-white font-semibold transition-colors whitespace-nowrap">
                                    {% if data.user.preferred_output == 'feet' %}Switch to Meters{% else %}Switch to Feet{% endif %}
                                </button>
                            </div>
                        </div>
                        <div id="unit-status-mobile" class="text-sm text-white/80 mt-2"></div>

                        <div class="flex justify-between items-center pt-2 border-t border-white/20">
                            <span class="text-white/80">My Lamps:</span>
                            <button id="showAddArduinoBtnMobile" class="text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded text-white font-semibold transition-colors">
                                + Link New Lamp
                            </button>
                        </div>
                        <div id="arduinoListMobile" class="space-y-2 mt-1">
                            {% for arduino in data.arduinos %}
                                <div class="flex justify-between items-center bg-white/10 rounded px-2 py-1 text-sm">
                                    <span class="text-white/60">#{{ arduino.arduino_id }}</span>
                                    <span class="font-medium">{{ arduino.location.replace(', Israel', '') }}</span>
                                </div>
                            {% endfor %}
                        </div>

                        <div id="addArduinoFormMobile" class="hidden mt-3 p-3 bg-black/20 rounded-lg border border-white/10">
                            <div class="space-y-3">
                                <div>
                                    <label class="text-white/60 text-xs block mb-1">Arduino ID:</label>
                                    <input type="number" id="newArduinoIdMobile" placeholder="e.g. 123456" 
                                           class="bg-white/10 text-white rounded px-3 py-1 text-sm border border-white/20 w-full">
                                </div>
                                <div>
                                    <label class="text-white/60 text-xs block mb-1">Location:</label>
                                    <select id="newArduinoLocationMobile" class="bg-gray-800 text-white rounded px-3 py-1 text-sm border border-white/20 w-full">
                                        {% for location in locations %}
                                            <option value="{{ location }}">{{ location }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="flex gap-2">
                                    <button id="cancelAddArduinoMobile" class="flex-1 bg-white/10 hover:bg-white/20 py-1 rounded text-xs text-white">Cancel</button>
                                    <button id="submitAddArduinoMobile" class="flex-1 bg-blue-500 hover:bg-blue-600 py-1 rounded text-xs text-white font-bold">Link Lamp</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-white/20">
                            <span class="text-white/80">Status:</span>
                            {% if data.conditions %}
                                <span class="status-online font-semibold">
                                    ‚óè Online
                                    {% if data.conditions.last_updated %}
                                        <span class="text-white/60 text-xs ml-1">(Data updated <span id="statusUpdateTimeMobile" data-timestamp="{{ data.conditions.last_updated.isoformat() }}Z">--</span>)</span>
                                    {% endif %}
                                </span>
                            {% else %}
                                <span class="status-offline font-semibold">‚óè No Data</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop View: Original Layout -->
            <div class="hidden lg:block p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Surf data Configuration</h2>
                
                <div class="space-y-3 text-white">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Location:</span>
                        <select id="locationSelect" aria-label="Select your location" class="bg-white/20 text-white rounded px-2 py-1 border border-white/30 text-sm font-semibold">
                            {% for location in locations %}
                                <option value="{{ location }}" {% if location == data.user.location %}selected{% endif %}>
                                    {{ location.replace(', Israel', '') }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="location-status" class="text-sm text-white/80 mt-2"></div>

                    <!-- Perfect Waves Range Slider -->
                    <div class="space-y-2 pt-2 border-t border-white/20">
                        <span class="text-white/80">Perfect Waves</span>
                        <div class="px-2 py-2">
                            <div id="waveSlider" class="my-4"></div>
                        </div>
                        <div id="threshold-status" class="text-sm text-white/80"></div>
                        <input type="hidden" id="waveThresholdMin"
                               value="{% if data.user.preferred_output == 'feet' %}{{ '%.1f'|format((data.user.wave_threshold_m if data.user.wave_threshold_m is not none else 0.0) * 3.28084) }}{% else %}{{ data.user.wave_threshold_m if data.user.wave_threshold_m is not none else 0.0 }}{% endif %}"
                               data-unit="{{ data.user.preferred_output or 'meters' }}">
                        <input type="hidden" id="waveThresholdMax"
                               value="{% if data.user.wave_threshold_max_m %}{% if data.user.preferred_output == 'feet' %}{{ '%.1f'|format(data.user.wave_threshold_max_m * 3.28084) }}{% else %}{{ data.user.wave_threshold_max_m }}{% endif %}{% endif %}">
                    </div>

                    <!-- Perfect Wind Range Slider -->
                    <div class="space-y-2 pt-2 border-t border-white/20">
                        <span class="text-white/80">Perfect Wind</span>
                        <div class="px-2 py-2">
                            <div id="windSlider" class="my-4"></div>
                        </div>
                        <div id="wind-threshold-status" class="text-sm text-white/80"></div>
                        <input type="hidden" id="windThresholdMin" value="{{ data.user.wind_threshold_knots or 22 }}">
                        <input type="hidden" id="windThresholdMax" value="{% if data.user.wind_threshold_max_knots %}{{ data.user.wind_threshold_max_knots }}{% endif %}">
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-white/20">
                        <span class="text-white/80">LED Colors:</span>
                        <div class="flex items-center space-x-2 w-32 justify-end">
                            <a href="{{ url_for('dashboard.themes_page') }}" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm text-white font-semibold transition-colors">
                                Configure
                            </a>
                        </div>
                    </div>
                    <div class="text-sm text-white/80 mt-2">
                        Current: {{ data.user.theme.replace('_', ' ').title() if data.user.theme else 'Ocean Breeze' }}
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-white/20">
                        <span class="text-white/80">Units:</span>
                        <div class="flex items-center space-x-2 justify-end">
                            <button id="unitToggle" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm text-white font-semibold transition-colors whitespace-nowrap">
                                {% if data.user.preferred_output == 'feet' %}Switch to Meters{% else %}Switch to Feet{% endif %}
                            </button>
                        </div>
                    </div>
                    <div id="unit-status" class="text-sm text-white/80 mt-2"></div>

                    <div class="flex justify-between items-center pt-2 border-t border-white/20">
                        <span class="text-white/80">My Lamps:</span>
                        <button id="showAddArduinoBtn" class="text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded text-white font-semibold transition-colors">
                            + Link New Lamp
                        </button>
                    </div>
                    <div id="arduinoList" class="space-y-2 mt-1">
                        {% for arduino in data.arduinos %}
                            <div class="flex justify-between items-center bg-white/10 rounded px-2 py-1 text-sm">
                                <span class="text-white/60">#{{ arduino.arduino_id }}</span>
                                <span class="font-medium">{{ arduino.location.replace(', Israel', '') }}</span>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Hidden Add Arduino Form -->
                    <div id="addArduinoForm" class="hidden mt-3 p-3 bg-black/20 rounded-lg border border-white/10">
                        <div class="space-y-3">
                            <div>
                                <label class="text-white/60 text-xs block mb-1">Arduino ID:</label>
                                <input type="number" id="newArduinoId" placeholder="e.g. 123456" 
                                       class="bg-white/10 text-white rounded px-3 py-1 text-sm border border-white/20 w-full">
                            </div>
                            <div>
                                <label class="text-white/60 text-xs block mb-1">Location:</label>
                                <select id="newArduinoLocation" class="bg-gray-800 text-white rounded px-3 py-1 text-sm border border-white/20 w-full">
                                    {% for location in locations %}
                                        <option value="{{ location }}">{{ location }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button id="cancelAddArduino" class="flex-1 bg-white/10 hover:bg-white/20 py-1 rounded text-xs text-white">Cancel</button>
                                <button id="submitAddArduino" class="flex-1 bg-blue-500 hover:bg-blue-600 py-1 rounded text-xs text-white font-bold">Link Lamp</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-white/20">
                        <span class="text-white/80">Status:</span>
                        {% if data.conditions %}
                            <span class="status-online font-semibold">
                                ‚óè Online
                                {% if data.conditions.last_updated %}
                                    <span class="text-white/60 text-xs ml-1">(Data updated <span id="statusUpdateTime" data-timestamp="{{ data.conditions.last_updated.isoformat() }}Z">--</span>)</span>
                                {% endif %}
                            </span>
                        {% else %}
                            <span class="status-offline font-semibold">‚óè No Data</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Surf Conditions Card -->
        <div class="card rounded-2xl p-4 lg:p-6 shadow-2xl order-1 lg:order-2">
            
            <!-- Mobile View: Single Row, No Title, Integers -->
            <div class="block lg:hidden">
                {% if data.conditions %}
                    <div class="grid grid-cols-4 gap-2">
                        <!-- Wave Height -->
                        <div class="text-center">
                            <div class="mb-1 flex items-center justify-center h-16">
                                <img src="{{ url_for('static', filename='icons/wave_height_new.png') }}" alt="Wave Height" class="max-h-full w-auto object-contain png-icon" style="transform: scale(1.15);">
                            </div>
                            <div class="text-white font-bold text-lg sm:text-xl">
                                {% if data.conditions.wave_height_m %}
                                    {% if data.user.preferred_output == 'feet' %}
                                        {{ "%.1f"|format(data.conditions.wave_height_m * 3.28084) }}ft
                                    {% else %}
                                        {{ "%.1f"|format(data.conditions.wave_height_m) }}m
                                    {% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                        </div>

                        <!-- Wave Period -->
                        <div class="text-center">
                            <div class="mb-1 flex items-center justify-center h-16">
                                <img src="{{ url_for('static', filename='icons/wave_period_new.png') }}" alt="Wave Period" class="max-h-full w-auto object-contain png-icon" style="transform: scale(1.15);">
                            </div>
                            <div class="text-white font-bold text-lg sm:text-xl">
                                {% if data.conditions.wave_period_s %}
                                    {{ data.conditions.wave_period_s | int }}s
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                        </div>

                        <!-- Wind Speed -->
                        <div class="text-center">
                            <div class="mb-1 flex items-center justify-center h-16">
                                <img src="{{ url_for('static', filename='icons/wind_speed_new.png') }}" alt="Wind Speed" class="max-h-full w-auto object-contain png-icon">
                            </div>
                            <div class="text-white font-bold text-lg sm:text-xl">
                                {% if data.conditions.wind_speed_mps %}
                                    {{ (data.conditions.wind_speed_mps * 1.94384) | int }} knots
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                        </div>

                        <!-- Wind Direction -->
                        <div class="text-center">
                            <div class="mb-1 flex items-center justify-center h-16">
                                <img src="{{ url_for('static', filename='icons/wind_direction_new.png') }}" alt="Wind Direction" class="max-h-full w-auto object-contain png-icon">
                            </div>
                            <div class="text-white font-bold text-lg sm:text-xl">
                                {{ data.conditions.wind_direction_deg }}¬∞
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- No Data Available Mobile -->
                    <div class="text-center py-4">
                        <div class="text-4xl mb-2 opacity-50">üì°</div>
                        <h3 class="text-lg font-semibold text-white mb-1">No Data</h3>
                        <p class="text-white/80 text-xs">Waiting for update...</p>
                    </div>
                {% endif %}
            </div>

            <!-- Desktop View: Original Layout -->
            <div class="hidden lg:block">
                <h2 class="text-2xl font-bold text-white mb-4">Current Surf Conditions</h2>
                {% if data.conditions %}
                    <div class="space-y-4">
                        <!-- Wave Data -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="wave-icon mb-2 h-32 flex items-center justify-center"><img src="{{ url_for('static', filename='icons/wave_height_new.png') }}" alt="Wave Height" class="mx-auto png-icon" style="width: 183px; height: 183px; transform: scale(1.15);"></div>
                                <div class="text-white font-bold text-xl">
                                    {% if data.conditions.wave_height_m %}
                                        {% if data.user.preferred_output == 'feet' %}
                                            {{ "%.1f"|format(data.conditions.wave_height_m * 3.28084) }}ft
                                        {% else %}
                                            {{ "%.1f"|format(data.conditions.wave_height_m) }}m
                                        {% endif %}
                                    {% else %}
                                        --
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-center">
                                <div class="wave-icon mb-2 h-32 flex items-center justify-center"><img src="{{ url_for('static', filename='icons/wave_period_new.png') }}" alt="Wave Period" class="mx-auto png-icon" style="width: 106px; height: 106px; transform: scale(1.15);"></div>
                                <div class="text-white font-bold text-xl">
                                    {% if data.conditions.wave_period_s %}
                                        {{ "%.1f"|format(data.conditions.wave_period_s) }}s
                                    {% else %}
                                        --
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Wind Data -->
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/20">
                            <div class="text-center">
                                <div class="wind-icon mb-2 h-32 flex items-center justify-center"><img src="{{ url_for('static', filename='icons/wind_speed_new.png') }}" alt="Wind Speed" class="mx-auto png-icon" style="width: 97px; height: 97px;"></div>
                                <div class="text-white font-bold text-xl">
                                    {% if data.conditions.wind_speed_mps %}
                                        {{ "%.1f"|format(data.conditions.wind_speed_mps * 1.94384) }} knots
                                    {% else %}
                                        --
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-center">
                                <div class="wind-icon mb-2 h-32 flex items-center justify-center"><img src="{{ url_for('static', filename='icons/wind_direction_new.png') }}" alt="Wind Direction" class="mx-auto png-icon" style="width: 141px; height: 141px;"></div>
                                <div class="text-white font-bold text-xl">
                                    {{ data.conditions.wind_direction_deg }}¬∞
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- No Data Available Desktop -->
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4 opacity-50">üì°</div>
                        <h3 class="text-xl font-semibold text-white mb-2">No Current Data</h3>
                        <p class="text-white/80 mb-4">
                            Your lamp hasn't received surf data yet. This could be because:
                        </p>
                        <ul class="text-white/70 text-sm space-y-1">
                            <li>‚Ä¢ Your lamp was recently registered</li>
                            <li>‚Ä¢ The monitoring system is updating</li>
                            <li>‚Ä¢ There's a temporary connection issue</li>
                        </ul>
                        <p class="text-white/80 text-sm mt-4">
                            Data updates every 30 minutes. Please check back soon!
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Light Configuration -->
    <div class="max-w-6xl mx-auto mt-8">
        
        <!-- Mobile View: Drawer/Accordion -->
        <div class="card rounded-2xl shadow-2xl lg:hidden overflow-hidden">
            <button onclick="document.getElementById('light-config-content').classList.toggle('hidden'); document.getElementById('light-config-chevron').classList.toggle('rotate-180');" 
                    class="w-full text-left p-6 flex justify-between items-center bg-white/5 hover:bg-white/10 transition-colors">
                <h2 class="text-xl font-bold text-white">Light Configuration</h2>
                <svg id="light-config-chevron" class="w-6 h-6 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div id="light-config-content" class="hidden border-t border-white/10 p-6">
                <div class="space-y-6">
                    <!-- LED Theme Configuration -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white/80">LED Colors:</span>
                            <div class="flex items-center space-x-2 w-32 justify-end">
                                <a href="{{ url_for('dashboard.themes_page') }}" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm text-white font-semibold transition-colors">
                                    Configure
                                </a>
                            </div>
                        </div>
                        <div class="text-sm text-white/80">
                            Current: {{ data.user.theme.replace('_', ' ').title() if data.user.theme else 'Ocean Breeze' }}
                        </div>
                    </div>

                    {% if off_hours_feature_enabled %}
                    <!-- Off Hours Configuration -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-white/80">Sleep Mode (Lamp Off):</span>
                            <span id="sleepModeStatusMobile" class="text-xs font-bold uppercase tracking-wider
                                {% if data.user.off_times_enabled %}
                                    text-orange-500
                                {% else %}
                                    text-white/50
                                {% endif %}">
                                {% if data.user.off_times_enabled %}Active{% else %}Disabled{% endif %}
                            </span>
                        </div>

                        <!-- Preset Buttons -->
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-2">
                                <button data-preset="typical" data-start="23:00" data-end="07:00"
                                        class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                        {% if data.user.off_times_enabled and data.user.off_time_start == '23:00' %}
                                            bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                        {% else %}
                                            bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                        {% endif %}">
                                    <span class="whitespace-nowrap block font-normal">Typical</span>
                                    <span class="opacity-60 text-base whitespace-nowrap block font-light">11pm-7am</span>
                                </button>
                                <button data-preset="early" data-start="22:00" data-end="06:00"
                                        class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                        {% if data.user.off_times_enabled and data.user.off_time_start == '22:00' %}
                                            bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                        {% else %}
                                            bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                        {% endif %}">
                                    <span class="whitespace-nowrap block font-normal">Early</span>
                                    <span class="opacity-60 text-base whitespace-nowrap block font-light">10pm-6am</span>
                                </button>
                                <button data-preset="night-owl" data-start="01:00" data-end="09:00"
                                        class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                        {% if data.user.off_times_enabled and data.user.off_time_start == '01:00' %}
                                            bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                        {% else %}
                                            bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                        {% endif %}">
                                    <span class="whitespace-nowrap block font-normal">Night Owl</span>
                                    <span class="opacity-60 text-base whitespace-nowrap block font-light">1am-9am</span>
                                </button>
                            </div>

                            <button id="customPresetBtnMobile"
                                    class="w-full text-sm py-2 rounded transition-all border
                                    {% if data.user.off_times_enabled and data.user.off_time_start not in ['23:00', '22:00', '01:00'] %}
                                        bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                    {% else %}
                                        bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                    {% endif %}">
                                Custom...
                            </button>
                        </div>

                        <!-- Custom Time Inputs (hidden by default) -->
                        <div id="customTimeInputsMobile" class="space-y-3 hidden bg-black/20 p-3 rounded-lg mt-2">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-white/60 text-xs block mb-1">Start (Off):</label>
                                    <input type="time" id="offTimeStartMobile"
                                           value="{{ data.user.off_time_start if data.user.off_time_start else '22:00' }}"
                                           class="bg-white/10 text-white rounded px-3 py-2 text-lg border border-white/20 w-full focus:border-blue-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="text-white/60 text-xs block mb-1">End (On):</label>
                                    <input type="time" id="offTimeEndMobile"
                                           value="{{ data.user.off_time_end if data.user.off_time_end else '06:00' }}"
                                           class="bg-white/10 text-white rounded px-3 py-2 text-lg border border-white/20 w-full focus:border-blue-500 focus:outline-none">
                                </div>
                            </div>
                            <button id="updateOffTimesMobile" class="w-full bg-blue-500 hover:bg-blue-600 py-1.5 rounded text-sm text-white font-semibold shadow-lg transition-transform active:scale-95">
                                Apply Schedule
                            </button>
                        </div>

                        <div id="off-times-status-mobile" class="text-xs font-semibold mt-2 h-4"></div>
                    </div>
                    {% endif %}

                    <!-- Brightness Control -->
                    <div class="{% if off_hours_feature_enabled %}pt-4 border-t border-white/20 {% endif %}space-y-2">
                        <span class="text-white/80 block mb-2">Brightness:</span>
                        <div class="flex gap-3">
                            <button data-brightness="{{ brightness_levels.LOW }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                                Low
                            </button>
                            <button data-brightness="{{ brightness_levels.MID }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                                Mid
                            </button>
                            <button data-brightness="{{ brightness_levels.HIGH }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                                High
                            </button>
                        </div>
                        <div id="brightness-status-mobile" class="text-sm text-white/80 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop View: Original Layout -->
        <div class="card rounded-2xl p-6 shadow-2xl hidden lg:block">
            <h2 class="text-xl font-bold text-white mb-4">Light Configuration</h2>

            <div class="space-y-6">
                {% if off_hours_feature_enabled %}
                <!-- Off Hours Configuration -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-white/80">Sleep Mode (Lamp Off):</span>
                        <span id="sleepModeStatus" class="text-xs font-bold uppercase tracking-wider
                            {% if data.user.off_times_enabled %}
                                text-orange-500
                            {% else %}
                                text-white/50
                            {% endif %}">
                            {% if data.user.off_times_enabled %}Active{% else %}Disabled{% endif %}
                        </span>
                    </div>

                    <!-- Preset Buttons -->
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-2">
                            <button data-preset="typical" data-start="23:00" data-end="07:00"
                                    class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                    {% if data.user.off_times_enabled and data.user.off_time_start == '23:00' %}
                                        bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                    {% else %}
                                        bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                    {% endif %}">
                                <span class="whitespace-nowrap block font-normal">Typical</span>
                                <span class="opacity-60 text-base whitespace-nowrap block font-light">11pm-7am</span>
                            </button>
                            <button data-preset="early" data-start="22:00" data-end="06:00"
                                    class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                    {% if data.user.off_times_enabled and data.user.off_time_start == '22:00' %}
                                        bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                    {% else %}
                                        bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                    {% endif %}">
                                <span class="whitespace-nowrap block font-normal">Early</span>
                                <span class="opacity-60 text-base whitespace-nowrap block font-light">10pm-6am</span>
                            </button>
                            <button data-preset="night-owl" data-start="01:00" data-end="09:00"
                                    class="preset-btn text-sm py-3 px-2 rounded transition-all border leading-tight
                                    {% if data.user.off_times_enabled and data.user.off_time_start == '01:00' %}
                                        bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                    {% else %}
                                        bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                    {% endif %}">
                                <span class="whitespace-nowrap block font-normal">Night Owl</span>
                                <span class="opacity-60 text-base whitespace-nowrap block font-light">1am-9am</span>
                            </button>
                        </div>

                        <button id="customPresetBtn"
                                class="w-full text-sm py-2 rounded transition-all border
                                {% if data.user.off_times_enabled and data.user.off_time_start not in ['23:00', '22:00', '01:00'] %}
                                    bg-orange-600/80 border-orange-500 text-white font-semibold shadow-[0_0_15px_rgba(234,88,12,0.3)]
                                {% else %}
                                    bg-white/10 hover:bg-white/20 text-white/80 border-white/20
                                {% endif %}">
                            Custom...
                        </button>
                    </div>

                    <!-- Custom Time Inputs (hidden by default) -->
                    <div id="customTimeInputs" class="space-y-3 hidden bg-black/20 p-3 rounded-lg mt-2">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-white/60 text-xs block mb-1">Start (Off):</label>
                                <input type="time" id="offTimeStart"
                                       value="{{ data.user.off_time_start if data.user.off_time_start else '22:00' }}"
                                       class="bg-white/10 text-white rounded px-3 py-2 text-lg border border-white/20 w-full focus:border-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="text-white/60 text-xs block mb-1">End (On):</label>
                                <input type="time" id="offTimeEnd"
                                       value="{{ data.user.off_time_end if data.user.off_time_end else '06:00' }}"
                                       class="bg-white/10 text-white rounded px-3 py-2 text-lg border border-white/20 w-full focus:border-blue-500 focus:outline-none">
                            </div>
                        </div>
                        <button id="updateOffTimes" class="w-full bg-blue-500 hover:bg-blue-600 py-1.5 rounded text-sm text-white font-semibold shadow-lg transition-transform active:scale-95">
                            Apply Schedule
                        </button>
                    </div>

                    <div id="off-times-status" class="text-xs font-semibold mt-2 h-4"></div>
                </div>
                {% endif %}

                <!-- Brightness Control -->
                <div class="{% if off_hours_feature_enabled %}pt-4 border-t border-white/20 {% endif %}space-y-2">
                    <span class="text-white/80 block mb-2">Brightness:</span>
                    <div class="flex gap-3">
                        <button data-brightness="{{ brightness_levels.LOW }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                            Low
                        </button>
                        <button data-brightness="{{ brightness_levels.MID }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                            Mid
                        </button>
                        <button data-brightness="{{ brightness_levels.HIGH }}" class="brightness-btn flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-lg transition-all border border-white/20">
                            High
                        </button>
                    </div>
                    <div id="brightness-status" class="text-sm text-white/80 mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="max-w-6xl mx-auto mt-6">
        
        <!-- Mobile View: Drawer + External Logout -->
        <div class="lg:hidden space-y-4">
            <div class="card rounded-2xl shadow-2xl overflow-hidden">
                <button onclick="document.getElementById('quick-actions-content').classList.toggle('hidden'); document.getElementById('quick-actions-chevron').classList.toggle('rotate-180');" 
                        class="w-full text-left p-6 flex justify-between items-center bg-white/5 hover:bg-white/10 transition-colors">
                    <h2 class="text-xl font-bold text-white">Quick Actions</h2>
                    <svg id="quick-actions-chevron" class="w-6 h-6 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div id="quick-actions-content" class="hidden border-t border-white/10 p-6">
                    <div class="flex flex-col gap-3">
                        {% if data.user.is_admin %}
                        <a href="{{ url_for('admin.arduino_monitor') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                            Arduino Monitor
                        </a>
                        <a href="{{ url_for('admin.admin_broadcast') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                            Broadcast Message
                        </a>
                        {% endif %}
                        <a href="{{ url_for('dashboard.wifi_setup_guide') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                            WiFi Setup
                        </a>
                        <button id="reportErrorBtnMobile" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors">
                            Report Error
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- External Logout Button -->
            <a href="{{ url_for('auth.logout') }}" class="block w-full card rounded-2xl p-4 shadow-2xl bg-blue-600 hover:bg-blue-700 text-white font-semibold text-center transition-colors">
                Logout
            </a>
        </div>

        <!-- Desktop View: Original Layout -->
        <div class="card rounded-2xl p-6 shadow-2xl hidden lg:block">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-2 justify-center">
                {% if data.user.is_admin %}
                <a href="{{ url_for('admin.arduino_monitor') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                    Arduino Monitor
                </a>
                <a href="{{ url_for('admin.admin_broadcast') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                    Broadcast Message
                </a>
                {% endif %}
                <a href="{{ url_for('dashboard.wifi_setup_guide') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                    WiFi Setup
                </a>
                <button id="reportErrorBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors">
                    Report Error
                </button>
                <a href="{{ url_for('auth.logout') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition-colors text-center">
                    Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Floating Chat Button -->
    <button id="chatFloatingBtn" aria-label="Open chat assistant" class="fixed bottom-6 right-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full p-4 shadow-2xl hover:shadow-blue-500/50 transition-all hover:scale-110 z-40 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </button>

    <!-- Chat Modal -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-blue-50 rounded-2xl shadow-2xl max-w-lg w-full mx-4 flex flex-col" style="height: 600px; max-height: 90vh;">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
                <h2 class="text-xl font-bold">Surf Lamp Assistant</h2>
                <button id="closeChatBtn" aria-label="Close chat assistant" class="text-white hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                <!-- Welcome message -->
                <div class="flex items-start space-x-2">
                    <div class="bg-blue-100 text-gray-800 rounded-2xl px-4 py-2 max-w-xs">
                        <p class="text-sm">Hi! I'm your Surf Lamp assistant. Ask me anything about how your lamp works, what the LED colors mean, or your current surf conditions!</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-2">
                    <input
                        type="text"
                        id="chatInput"
                        aria-label="Chat message input"
                        placeholder="Ask a question..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                        maxlength="500"
                    >
                    <button id="sendChatBtn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full px-6 py-2 font-semibold transition-colors">
                        Send
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Powered by Gemini AI ‚Ä¢ Read-only assistant</p>
            </div>
        </div>
    </div>

    <!-- Broadcast Notifications (bottom-left to avoid chat button) -->
    <div id="broadcastContainer" class="fixed bottom-6 left-6 z-40 space-y-3 max-w-sm"></div>

    <!-- Dashboard Configuration -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <!-- Utilities -->
    <script src="{{ url_for('static', filename='js/status-messages.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>

    <!-- Features -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="{{ url_for('static', filename='js/features/location-update.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/wave-threshold.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/wind-threshold.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/brightness-control.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/unit-preference.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/off-hours.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/error-report.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/chat-assistant.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/broadcasts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features/arduino-management.js') }}"></script>

    <!-- LED Visualization -->
    <script src="{{ url_for('static', filename='js/led-visualization/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/led-visualization/data-fetcher.js') }}"></script>

    <!-- Error Report Modal -->
    <div id="errorReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Report an Error</h2>

            <form id="errorReportForm">
                <div class="mb-4">
                    <label for="errorDescription" class="block text-gray-700 font-semibold mb-2">
                        Describe the issue you're experiencing:
                    </label>
                    <textarea
                        id="errorDescription"
                        rows="6"
                        maxlength="1000"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                        placeholder="Example: My lamp LEDs are not updating after I changed my location..."
                    ></textarea>
                    <div class="text-right text-sm text-gray-500 mt-1">
                        <span id="charCount">0</span>/1000 characters
                    </div>
                </div>

                <div id="errorReportStatus" class="mb-4 text-sm hidden"></div>

                <div class="flex justify-end space-x-3">
                    <button
                        type="button"
                        id="cancelErrorReport"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        id="submitErrorReport"
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors"
                    >
                        Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Initialize feature handlers
    LocationUpdate.init('{{ data.user.location }}');
    WaveThreshold.init();
    WindThreshold.init();
    BrightnessControl.init({{ data.user.brightness_level or brightness_levels.MID }});
    UnitPreference.init('{{ data.user.preferred_output or "meters" }}');

    // Night Mode (Off Hours) - Preset & Custom Controls
    {% if off_hours_feature_enabled %}
    OffHours.init();
    {% endif %}

    // LED Visualization
    LEDDataFetcher.init({{ data.arduinos[0].arduino_id if data.arduinos else 0 }}, '{{ data.user.theme }}');

    // Underlayer Control Panel
    window.underlayerConfig = {
        left: { xOffset: 0, yOffset: 0, opacity: 0.3, color: '#4a5568' },
        center: { xOffset: 0, yOffset: 0, opacity: 0.3, color: '#4a5568' },
        right: { xOffset: 0, yOffset: 0, opacity: 0.3, color: '#4a5568' }
    };

    function toggleUnderlayerPanel() {
        const panel = document.getElementById('underlayerControlPanel');
        const btn = document.getElementById('underlayerToggleBtn');
        panel.classList.toggle('hidden');
        btn.classList.toggle('hidden');
    }

    function setupUnderlayerControls() {
        const strips = ['left', 'center', 'right'];

        strips.forEach(strip => {
            // X Offset
            const xInput = document.getElementById(`${strip}X`);
            const xVal = document.getElementById(`${strip}XVal`);
            xInput.addEventListener('input', (e) => {
                window.underlayerConfig[strip].xOffset = parseFloat(e.target.value);
                xVal.textContent = e.target.value;
            });

            // Y Offset
            const yInput = document.getElementById(`${strip}Y`);
            const yVal = document.getElementById(`${strip}YVal`);
            yInput.addEventListener('input', (e) => {
                window.underlayerConfig[strip].yOffset = parseFloat(e.target.value);
                yVal.textContent = e.target.value;
            });

            // Opacity
            const opacityInput = document.getElementById(`${strip}Opacity`);
            const opacityVal = document.getElementById(`${strip}OpacityVal`);
            opacityInput.addEventListener('input', (e) => {
                window.underlayerConfig[strip].opacity = parseFloat(e.target.value);
                opacityVal.textContent = parseFloat(e.target.value).toFixed(2);
            });

            // Color
            const colorInput = document.getElementById(`${strip}Color`);
            colorInput.addEventListener('input', (e) => {
                window.underlayerConfig[strip].color = e.target.value;
            });
        });
    }

    function exportUnderlayerConfig() {
        const output = document.getElementById('configOutput');
        const config = JSON.stringify(window.underlayerConfig, null, 2);
        output.textContent = `// Underlayer Configuration:\n${config}`;
        output.classList.remove('hidden');
    }

    setupUnderlayerControls();

    // Error Report Modal
    ErrorReport.init();

    // Chat Assistant
    ChatAssistant.init();

    // Broadcast Notifications
    Broadcasts.init();

    // Arduino Management (Link New Lamp)
    ArduinoManagement.init();

    // Status Update Time Display
    function formatTimeAgo(isoTimestamp) {
        const now = new Date();
        const updated = new Date(isoTimestamp);
        const diffMs = now - updated;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return "just now";
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${Math.floor(diffHours / 24)}d ago`;
    }

    function updateStatusTime() {
        // Update desktop element
        const elem = document.getElementById('statusUpdateTime');
        const timestamp = elem?.dataset.timestamp;
        if (timestamp) {
            elem.textContent = formatTimeAgo(timestamp);
        }

        // Update mobile element
        const elemMobile = document.getElementById('statusUpdateTimeMobile');
        const timestampMobile = elemMobile?.dataset.timestamp;
        if (timestampMobile) {
            elemMobile.textContent = formatTimeAgo(timestampMobile);
        }
    }

    // Update status time on page load and every minute
    updateStatusTime();
    setInterval(updateStatusTime, 60000);

    </script>
    <script src="{{ url_for('static', filename='js/flash-messages.js') }}"></script>

    {% include 'partials/legal_footer.html' %}
</body>
</html>
